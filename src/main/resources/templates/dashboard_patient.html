<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{layout :: head}"></head>

<body>

    <nav th:replace="~{layout :: navbar}"></nav>

    <div class="container mt-4">
        <h2>Mi Portal de Salud</h2>
        <div class="alert alert-success">
            Bienvenido, <span th:text="${#authentication.name}">Paciente</span>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Mis Citas</div>
                    <div class="card-body">
                        <p>Gestiona tus próximas citas médicas.</p>
                        <a th:href="@{/patient/appointments}" class="btn btn-primary">Ver Mis Citas</a>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Historial Médico</div>
                    <div class="card-body">
                        <p>Consulta tu historial y resultados clínicos.</p>
                        <a th:href="@{/patient/history}" class="btn btn-info text-white">Ver Historial</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">Evolución de Salud</div>
                    <div class="card-body">
                        <p th:if="${#lists.isEmpty(labels)}">Aún no hay registros clínicos para mostrar.</p>

                        <div class="row" th:if="${!#lists.isEmpty(labels)}">
                            <div class="col-md-6 mb-4">
                                <h5>Hemoglobina</h5>
                                <div style="height:220px;"><canvas id="chartHemoglobin"></canvas></div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <h5>Peso</h5>
                                <div style="height:220px;"><canvas id="chartWeight"></canvas></div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <h5>Triglicéridos</h5>
                                <div style="height:220px;"><canvas id="chartTriglycerides"></canvas></div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <h5>Azúcar en sangre</h5>
                                <div style="height:220px;"><canvas id="chartBloodSugar"></canvas></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{layout :: footer}"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        const labels = /*[[${labels}]]*/ [];
        const weights = /*[[${weights}]]*/ [];
        const hemoglobins = /*[[${hemoglobins}]]*/ [];
        const triglycerides = /*[[${triglycerides}]]*/ [];
        const bloodSugars = /*[[${bloodSugars}]]*/ [];

        function createLineChart(canvasId, label, data, color) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: label,
                            data: data,
                            borderColor: color,
                            tension: 0.2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        if (labels.length > 0) {
            createLineChart('chartHemoglobin', 'Hemoglobina (g/dL)', hemoglobins, 'rgba(255, 99, 132, 1)');
            createLineChart('chartWeight', 'Peso (kg)', weights, 'rgba(54, 162, 235, 1)');
            createLineChart('chartTriglycerides', 'Triglicéridos (mg/dL)', triglycerides, 'rgba(255, 159, 64, 1)');
            createLineChart('chartBloodSugar', 'Glucosa (mg/dL)', bloodSugars, 'rgba(75, 192, 192, 1)');
        }
        /*]]>*/
    </script>

</body>

</html>